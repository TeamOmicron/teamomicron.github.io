



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation website for Team Omicron from BBC Robotics, competing in the RoboCup Jr 2020 Internationals.">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Omicam (vision and localisastion) - Team Omicron</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#omicam" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Team Omicron" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Team Omicron
            </span>
            <span class="md-header-nav__topic">
              
                Omicam (vision and localisastion)
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Team Omicron" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Team Omicron
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Hardware
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Hardware
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../structural_design/" title="Structural design" class="md-nav__link">
      Structural design
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Software
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Software
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Omicam (vision and localisastion)
      </label>
    
    <a href="./" title="Omicam (vision and localisastion)" class="md-nav__link md-nav__link--active">
      Omicam (vision and localisastion)
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background-and-previous-methods" class="md-nav__link">
    Background and previous methods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-and-results" class="md-nav__link">
    Performance and results
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    Hardware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#field-object-detection" class="md-nav__link">
    Field object detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#localisation" class="md-nav__link">
    Localisation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#previous-methods" class="md-nav__link">
    Previous methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#our-solution" class="md-nav__link">
    Our solution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interfacing-with-omicontrol" class="md-nav__link">
    Interfacing with Omicontrol
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    Debugging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../omicontrol/" title="Omicontrol (debugging and control)" class="md-nav__link">
      Omicontrol (debugging and control)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../strategy/" title="Game strategies" class="md-nav__link">
      Game strategies
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../protobuf/" title="Protocol Buffers" class="md-nav__link">
      Protocol Buffers
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background-and-previous-methods" class="md-nav__link">
    Background and previous methods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-and-results" class="md-nav__link">
    Performance and results
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    Hardware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#field-object-detection" class="md-nav__link">
    Field object detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#localisation" class="md-nav__link">
    Localisation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#previous-methods" class="md-nav__link">
    Previous methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#our-solution" class="md-nav__link">
    Our solution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interfacing-with-omicontrol" class="md-nav__link">
    Interfacing with Omicontrol
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    Debugging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="omicam">Omicam</h1>
<p>One of the biggest innovation Team Omicron brings this year is our advanced, all-in-one, custom developed vision and
localisation application called <em>Omicam</em>. The application is developed mostly in C, with some C++ code to interface with
OpenCV. It runs on the powerful LattePanda Delta 432 single board computer and uses Linux (Xubuntu 18.04) as its OS.</p>
<p>We are proud to report that Omicam is a significant step up compared to previous vision applications in use at BBC
Robotics, as you will see below.</p>
<p>Omicam consists of <strong>X</strong> lines of code, and took about <strong>X</strong> hours to develop.</p>
<h2 id="background-and-previous-methods">Background and previous methods</h2>
<p>Intelligent, accurate and fast computer vision continues to become increasingly important in RoboCup Jr Open Soccer.
With the introduction of the orange ball and advanced teams' application of "ball-hiding" strategies, accurate and fast
computer vision is now one of the most important elements of a successful RoboCup Jr Open robot.</p>
<p>Previously, our team used an OpenMV H7 to provide vision. This is a module which uses an STM32 MCU combined combined with
an OmniVision camera module to provide low-resolution vision in an easy-to-use MicroPython environment. However, although
this approach is functional, its resolution and framerate are extremely limiting for our use case. Hence, we decided the
best solution was to do what the most advanced teams were doing, and develop a custom vision application running on a 
single board computer (SBC).</p>
<p><strong>TODO cover Omicam development with other SBCs</strong></p>
<h2 id="performance-and-results">Performance and results</h2>
<p>Omicam is capable of detecting 4 field objects at <strong>over 60fps at 720p (1280x720) resolution</strong>. Compared to the previous
OpenMV H7, this is <strong>12x higher resolution at 3x the framerate.<sup>1</sup></strong></p>
<p>In addition, using the novel vision-based localisation algorithm we developed this year, we can now determine the
robot's position to <strong>~1cm accuracy</strong> at realtime speeds. This is over <strong>5x/25x more accurate<sup>2</sup></strong> than any previous methods 
used at BBC Robotics, and has been shown to be much more reliable and stable.</p>
<p>To achieve this performance, we made heavy use of parallel programming techniques, OpenCV's x86 SIMD CPU optimisations,
Clang optimiser flags as well as intelligent image downscaling for the goal threshold images (as they are mostly unused).
In addition, the localisation, vision and remote debug pipelines all run in parallel to each other so the entire application
is asynchronous.</p>
<p><em><sup>1 results based on mediocre lighting conditions running well optimised OpenMV H7 code at QVGA resolution.</sup></em> </p>
<p><em><sup>2 depending on whether LRF based/goal based localisation was used.</sup></em></p>
<h2 id="hardware">Hardware</h2>
<p>Omicam runs on a Linux-based LattePanda Delta 432. The camera used is a USB 2.0 camera using the OV 4689 sensor which can 
capture video footage at 720p 60 FPS.</p>
<p><strong>More here, camera and stuff.</strong></p>
<h2 id="field-object-detection">Field object detection</h2>
<p>The primary responsibility of Omicam is to detect field objects: the ball, goals and also lines. To do this, we use the 
popular computer vision library OpenCV, v4. We use Linux's UVC driver to acquire an MJPEG stream from the USB camera. 
Then, we apply any pre-processing steps such as downscaling the goal frames and gamma boosting.</p>
<p>Next, we threshold all objects in parallel to make use of our quad-core CPU, using OpenCV's thresholding function but a custom
parallel framework (as it doesn't run in parallel by default). 
Then, we use OpenCV's parallel connected component labeller, specifically the algorithm by Grana et al[1] to detect regions
of the same colour in the image. The largest connected region will be the field object we are looking for.</p>
<p>We then dispatch the largest detected blob's centroid via UART to the ESP32, encoded using Protocol Buffers.</p>
<p><strong>TODO describe in more detail</strong></p>
<h2 id="localisation">Localisation</h2>
<p>Localisation is the problem of detecting where the robot is on the field. This information is essential to know in order
to develop advanced strategies and precise movement control, instead of just driving directly towards the ball.</p>
<h3 id="previous-methods">Previous methods</h3>
<p>Currently, teams use three main ways of localisation. Firstly, the simplest approach uses the detected goals
in the camera to estimate the robot's position. This approach is very inaccurate because of the low resolution of
most cameras (such as the OpenMV), the fact that there are only two goals to work with as well as the fact that sometimes
the goals are not visible (especially in super team). Expected accuracy is 15-25cm.</p>
<p>The second approach in use is based on distance sensors such laser range finders (LRFs) or ultrasonic sensors. By using
several of these sensors on a robot, the position of the robot can be inferred with trigonometry, by measuring the distance
to the walls. This approach has a major drawback: it is impossible to reliably distinguish between anomalous objects,
such as a hand or another robot, compared to a wall. This means that although this approach is somewhat accurate on an empty
field, it is very difficult to use reliably in actual games. Thus, localisation data was almost never trusted by teams
who used this approach and so is not very helpful. In addition, distances sensors, especially ultrasonics, are slow and suffer 
from inaccuracy at long distances. Expected accuracy is 5-10cm, but data is invalidated every time a robot moves in the way of a sensor,
which is impossible to know.</p>
<p>The third approach in use by some teams is one based on 360 degree LiDARS. These are expensive, heavy, difficult to use, slow and are
still vulnerable to all the problems the second approach suffers from as well. We are not aware of expected accuracy, but regard
this as not an ideal approach.</p>
<h3 id="our-solution">Our solution</h3>
<p>This year, Team Omicron presents a novel approach to robot localisation based on a middle-size league paper by Lu, Li, Zhang,
Hu &amp; Zheng (2013). We localise using purely RGB camera data by solving a non-linear optimisation problem using the lines on the
playing field.</p>
<p>In practice, this works by the vision processor passing its thresholded line data to the localiser. Using its worker threads,
a certain number of rays are casted on the line image using Bresenham's line algorithm[3] to find every time a ray intersects
a line (these are called "line points"). Using a manually determined equation, these points are then dewarped to counter
the distortion of the 360 degree mirror.</p>
<p>To localise, the Subplex[4] non-linear optimiser (part of the NLopt package[5]) is used to minimise an objective function that 
<strong>TODO describe what it does in simple terms.</strong></p>
<p>In simple terms, we optimise by moving a virtual robot around on a field and comparing the distances between what it might
see and what we <em>really</em> see to "reverse-engineer" the (x,y) position of the real robot.</p>
<h2 id="interfacing-with-omicontrol">Interfacing with Omicontrol</h2>
<p>To interface with our remote management application Omicontrol, Omicam starts a TCP server on port 42708. This server sends
Protocol Buffer packets containing JPEG encoded frames, zlib compressed threshold data as well as other information such as
the temperature of the SBC.</p>
<p>We use the SIMD optimised libjpeg-turbo to efficiently encode JPEG frames, so as to not waste performance to the remote debugger
(which is disabled during competition). Instead of compressing threshold frames with JPEG, because they are 1-bit images,
it was determined that zlib could compress them more efficiently (around about 460,800x reduction in size). </p>
<p>With all these optimisations, even at high framerates (60+ packets per second), the remote debug system only uses 300KB/s to 1 MB/s 
of network bandwidth.</p>
<h2 id="debugging">Debugging</h2>
<p>Low-level compiled languages such as C and C++ are notoriously unstable. In order to improve the stability of Omicam
and fix bugs, we used Google's Address Sanitizer to easily find and trace a variety of bugs such as buffer overflows,
memory leaks and more. In addition, we used the LLVM toolchain's debugger lldb to analyse the application frequently.</p>
<p>To assist in performance evaluation, we used the Linux tool OProfile to determine the slowest method calls in the application.</p>
<h2 id="references">References</h2>
<p><strong>TODO USE MENDELEY</strong></p>
<p>[1] C. Grana, D. Borghesani, and R. Cucchiara, “Optimized Block-based Connected Components Labeling with Decision Trees,” IEEE Transac-tions on Image Processing, vol. 19, no. 6, pp. 1596–1609, 2010.</p>
<p>[2] <strong>TODO CITE PROPERLY</strong> Robust and Real-time Self-Localization Based on Omnidirectional Vision for Soccer Robots</p>
<p>[3] Bresenham's paper</p>
<p>[4] Subplex paper</p>
<p>[5] NLopt paper</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../structural_design/" title="Structural design" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Structural design
              </span>
            </div>
          </a>
        
        
          <a href="../omicontrol/" title="Omicontrol (debugging and control)" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Omicontrol (debugging and control)
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>