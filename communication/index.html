
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation website for Team Omicron, an open-source RoboCup Jr Open Soccer team from Brisbane Boys' College.">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.7">
    
    
      
        <title>Communication - Team Omicron</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.19753c6b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.196e0c26.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#communication" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Team Omicron" class="md-header-nav__button md-logo" aria-label="Team Omicron">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Team Omicron
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Communication
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Team Omicron" class="md-nav__button md-logo" aria-label="Team Omicron">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Team Omicron
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
    <label class="md-nav__link" for="nav-3">
      Hardware
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Hardware" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Hardware
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../structural_design/" class="md-nav__link">
      Structural design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../electrical_design/" class="md-nav__link">
      Electrical design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../sbc/" class="md-nav__link">
      SBC & Camera
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    <label class="md-nav__link" for="nav-4">
      Software
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Software" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Software
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open_source_release/" class="md-nav__link">
      Our open-source release!
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../omicam/" class="md-nav__link">
      Omicam
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../omicontrol/" class="md-nav__link">
      Omicontrol
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fsm/" class="md-nav__link">
      Finite State Machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../strategy/" class="md-nav__link">
      Game strategies
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../protobuf/" class="md-nav__link">
      Protocol Buffers
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Communication
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Communication
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bluetooth-communication" class="md-nav__link">
    Bluetooth communication
  </a>
  
    <nav class="md-nav" aria-label="Bluetooth communication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-in-omicron" class="md-nav__link">
    Implementation in Omicron
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uart-communication" class="md-nav__link">
    UART communication
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lowlevel/" class="md-nav__link">
      Low-level code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../open_source/" class="md-nav__link">
      Third party library notices
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../future_work/" class="md-nav__link">
      Future ideas
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bluetooth-communication" class="md-nav__link">
    Bluetooth communication
  </a>
  
    <nav class="md-nav" aria-label="Bluetooth communication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-in-omicron" class="md-nav__link">
    Implementation in Omicron
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uart-communication" class="md-nav__link">
    UART communication
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="communication">Communication</h1>
<p><em>Page author: Matt Young, vision systems &amp; low-level developer</em></p>
<p>Inter-robot communication is an extremely important aspect of RoboCup Jr. Using wireless protocols such as Zigbee or
Bluetooth allows robots to exchange game strategy information with each other, switch FSM states and much more. This year,
building on our codebase from last year, we have Bluetooth Classic communication between the two robots using the ESP32&rsquo;s
built in wireless module and it&rsquo;s implementation in the IDF API.</p>
<p>Likewise, intra-robot communication is an essential aspect of a multi-micro-controller setup like the one we have.
This year, we extend our previous Protocol Buffer, UART-backed communication protocol to include a CRC8 checksum and better
error handling to improve reliability.</p>
<p><strong>Note:</strong> Some of this documentation is borrowed from the RoboCup 2019 Sydney submission by our previous team (Deus Vult).</p>
<h2 id="bluetooth-communication">Bluetooth communication</h2>
<p>Our Bluetooth inter-robot comms remain largely unchanged from last year, minus a few bug fixes and more testing.</p>
<h3 id="background">Background</h3>
<p>Bluetooth is a low-power wireless communications protocol used in many devices. Our ESP32s support both Bluetooth
Classic v4 Enhanced Data Rate (EDR) and Bluetooth Low Energy (LE). We opted to use the BT Classic as its simpler and has
faster speeds. On the ESP32, Bluetooth, like most other things, is highly parallel and runs in separate threads on its
own core (core 0). This means that our code, which runs on core 1, can run totally asynchronously to Bluetooth.</p>
<h3 id="implementation-in-omicron">Implementation in Omicron</h3>
<p>Bluetooth is an extremely complicated protocol with many layers and quirks, but in essence, we use a Simple Port Profile
(SPP) to connect to the other robot using Simple Secure Pairing (SSP).</p>
<p>We have two robots, Robot 0 and Robot 1. Robot 0 is the “host”, who establishes an SPP server. Robot 1 is the “client”,
who discovers Robot 0 and connects to it. </p>
<p>Our Bluetooth aims to be very reliable, and on the event of a disconnect, the client will continuously attempt to
reconnect to the host. Similarly, the host will always be listening for a new client on disconnect. If too many Protobuf
decode errors occur, the server will disconnect the client. We also use whitelisting to make sure no foreign devices can
interrupt our Bluetooth connectivity by connecting during a game.</p>
<p>Our Bluetooth communication uses Protocol Buffers. Each robot runs a receive and send task. The receive
tasks reads Protobuf byte streams and decodes them, while send task encodes Protobuf byte streams and sends them.</p>
<p>The default Bluetooth timeout is about 3 seconds, which is too slow for our purposes. Instead, we programmed a custom
timer for 800ms where if a packet is not received within this time, the other robot is considered off for damage. When
this is detected, the other robot destroys the Bluetooth connection and enters into defence.</p>
<p>We also have some complex conflict resolution code. Both robots send each other’s FSM states, and if both are in attack
or both are in defence, an algorithm is run to resolve the conflict, which works by having the robot closest to the goal
become the defender, as well as some code to deal with special circumstances such as if a robot can’t see the goal.</p>
<p>One of the most important parts of Bluetooth is switching. Inside the FSM, each robot will set a boolean true/false if
they themselves are willing to switch. The attacker is willing to switch almost all of the time, except when its doing
something important like shooting or dribbling to goal. The defender will only switch in much more specific
circumstances like if it’s surging (the ball is in front of it and its close to the goal). One robot, robot 0, is the
designated “switch observer”. It will observe if it’s willing to switch and the other robot is willing to switch, and if
so, broadcast a special message over Bluetooth that causes each robot to invert its state. To prevent fast-paced
switching that’s detrimental to gameplay, a switch timer is also used which means the robot is only permitted to switch
every 1.5 seconds.</p>
<h2 id="uart-communication">UART communication</h2>
<p>Last year, we improved our communication infrastructure significantly by switching from I2C to UART and using Protocol
Buffers instead of an arbitrary, bit-shifted binary format. For our purposes, we found I2C to be too error-prone and 
complex, with small payload sizes. Instead, through testing we observed that UART on 115200 baud rate was simpler
to setup and use, more reliable and fast enough for our situation.</p>
<p>This year, we continue our tradition of using Protocol Buffers for everything imaginable in our comms protocol, but also
extend our communication protocol (nicknamed <em>JimBus</em> after a member on our team) to improve reliability.</p>
<p>A standard JimBus message sent over UART has the following structure:</p>
<ul>
<li>Byte <code>0x0B</code> to indicate message start</li>
<li>Message ID</li>
<li>Message length</li>
<li>Protobuf data (message contents)</li>
<li>CRC8 checksum of protobuf data</li>
</ul>
<p>Essentially, our messages have a 3 byte header and a 1 byte checksum. JimBus, our custom UART comms protocol, runs on
the ESP32, the Teensy 3.5 and even the LattePanda using POSIX termios, so it&rsquo;s highly cross-platform and easy to decode.
We introduced a CRC8 checksum this year to ensure that, when a message is corrupted due to electrical noise, the
Protobuf decoding doesn&rsquo;t spectacuarly fail. Instead, if the received CRC8 checksum doesn&rsquo;t match the received checksum
(calculated before sending by the other device), we reject the message, log an error and attempt to resync the UART
stream.</p>
<p>In future, we would like to add an extra byte to the message size field so we can transmit messages longer than 255
bytes, and also use a CRC32 checksum instead of CRC8 for better accuracy.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../protobuf/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Protocol Buffers
              </div>
            </div>
          </a>
        
        
          <a href="../lowlevel/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Low-level code
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright (c) 2020 Team Omicron. Documentation is under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.0ac82a11.min.js"></script>
      <script src="../assets/javascripts/bundle.f81dfb4d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>